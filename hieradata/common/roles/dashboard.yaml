---
include:
  default:
    - profile::openstack::dashboard
    - profile::logging::rsyslog::client
    - profile::webserver::apache::status
    - profile::openstack::cache
    - profile::base::systemd

named_interfaces::config:
  mgmt:
    - eth0
  trp:
    - eth1
  public:
    - dummy0

profile::base::common::packages:
  # we need newer version of six to avoid breaking requests and openstack cli
  'python3-six.noarch': { ensure: latest }
  'MySQL-python': {}            # FIXME: remove when el7 is gone
  'python3-mysql': {}
  'bash-completion': {}
  'bash-completion-extras': {}  # FIXME: remove when el7 is gone
  'jq': {}
  'openstack-selinux': {}
  'python2-designateclient': {} # FIXME: remove when el7 is gone
  'python3-designateclient': {}

profile::openstack::dashboard::designate_packages:
  'openstack-designate-ui': {}

profile::base::network::manage_dummy:                              true # FIXME; remove when el7 is gone

profile::base::common::manage_cron:                                true
profile::base::selinux::manage_selinux:                            true
profile::network::interface::manage_dummy:                         true
profile::openstack::dashboard::manage_dashboard:                   true
profile::webserver::apache::manage_firewall:                       false
profile::openstack::dashboard::manage_firewall:                    true
profile::openstack::dashboard::manage_overrides:                   true
profile::openstack::dashboard::enable_pwd_retrieval:               true
profile::openstack::dashboard::change_region_selector:             true
profile::openstack::dashboard::change_login_footer:                true
profile::openstack::dashboard::customize_logo:                     true
profile::openstack::dashboard::image_upload_mode:                  'direct'
profile::openstack::dashboard::session_cookie_httponly:            true
profile::openstack::dashboard::use_ssl:                            true
profile::openstack::dashboard::cutomize_charts_dashboard_overview: true
profile::openstack::dashboard::access_control_allow_origin:        "console.%{hiera('domain_public')}"
profile::openstack::dashboard::disallow_iframe_embed:              true
profile::openstack::dashboard::csrf_cookie_secure:                 true
profile::openstack::dashboard::session_cookie_secure:              true
profile::openstack::dashboard::disable_password_reveal:            true
profile::openstack::dashboard::enforce_password_check:             true
profile::openstack::dashboard::secure_proxy_header:                '("HTTP_X_FORWARDED_PROTOCOL", "https")'
profile::openstack::dashboard::password_autocomplete:              "off"

# cronjob to cleanup expired session from db
profile::base::cron::crontabs:
  django_clearsessions:
    ensure:   present
    command:  '/usr/share/openstack-dashboard/manage.py clearsessions > /dev/null 2>&1'
    hour:     6
    minute:   30

# Enable extra yum repo
profile::base::yumrepo::repo_hash:
  rdo-release:
    ensure: present
  CentOS-PowerTools: # FIXME: remove when CentOS 8 is gone
    ensure: present
  AlmaLinux-PowerTools:
    ensure: present
  epel: # should be absent when using RDO, but whitelist can also work
    ensure:   present
    includepkgs: 'htop bash-completion-extras python3-mysql'

# Sensu
profile::webserver::apache::status::manage_status: true
profile::monitoring::sensu::agent::plugins:
  sensu-plugins-apache:
    type:         package
    pkg_version:  '3.0.0'

profile::monitoring::sensu::agent::checks:
  'metrics-httpd-overview':
    type:         'metric'
    command:      "metrics-apache-graphite.rb --scheme httpd.%{::hostname} -h 127.0.0.1"
    interval:     60
    subscribers:  ['metrics']
    handlers:     ['graphite_tcp']

# We should change this to the same as the API services
profile::openstack::dashboard::policies:
  glance_publicize_image:
    file_path:  '/etc/openstack-dashboard/glance_policy.json'
    key:        'publicize_image'
    value:      'role:superuser or role:admin'
  nova_disable_reboot:
    file_path:  '/etc/openstack-dashboard/nova_policy.json'
    key:        'os_compute_api:servers:reboot'
    value:      'role:admin'
  nova_compute_resize:
    file_path:  '/etc/openstack-dashboard/nova_policy.json'
    key:        'os_compute_api:servers:resize'
    value:      'role:admin'
  nova_disable_shelve:
    file_path:  '/etc/openstack-dashboard/nova_policy.json'
    key:        'os_compute_api:servers:shelve'
    value:      'role:admin'
#  upload_image:
#    key:        'volume_extension:volume_actions:upload_image'
#    value:      'role:admin'
#    file_path:  '/etc/openstack-dashboard/cinder_policy.json'

# Cache memory usage
memcached::max_memory: '40%'

# Session database
profile::openstack::dashboard::database:
  database:       'horizon'
  password_hash:  "%{hiera('horizon_db_password')}"
  host:           "%{hiera('service__address__db_regional')}"

profile::base::selinux::boolean:
  'httpd_can_network_connect':
    ensure: 'on'
    persistent: true

# Disable admin functionality (use mgmt dashboard for this)
horizon::keystone_options:
  can_edit_user:                False
  can_edit_group:               False
  can_edit_project:             False
  can_edit_domain:              False
  can_edit_role:                False

# Adjust the ulimit (number of open files) for Apache via systemd
profile::base::systemd::manage_limits: true
profile::base::systemd::limits:
  httpd:
    limits:
      Service:
        'LimitNOFILE': 32768

profile::openstack::dashboard::user_menu_links: '[]'

apache::mod::ssl::ssl_cipher:   "HIGH:!aNULL:!MD5:!3DES"
apache::mod::ssl::ssl_protocol: [ 'all', '-SSLv2', '-SSLv3', '-TLSv1', '-TLSv1.1' ]

openstack_version: 'ussuri'
