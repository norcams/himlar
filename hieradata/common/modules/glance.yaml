---
# db (node: image)
glance::db::mysql::allowed_hosts:
  - "%{netpart_trp1}.%"

# api (node: image)
glance::api::database_connection:          "mysql+pymysql://glance:%{hiera('glance::db::mysql::password')}@%{hiera('service__address__db_regional')}/glance"
glance::api::os_region_name:               "%{location}"
glance::api::bind_host:                    "%{::ipaddress_trp1}"
glance::api::workers:                      2
glance::api::registry_host:                "%{::netpart_trp1}.36" #FIXME remove registry before image-02
glance::api::show_image_direct_url:        true
glance::api::show_multiple_locations:      true
glance::api::use_syslog:                   true
glance::api::log_facility:                 'LOG_LOCAL3'
glance::api::enable_proxy_headers_parsing: true
glance::api::enable_v1_api:                false
glance::api::enable_v2_api:                true

glance::api::authtoken::auth_uri:          "%{hiera('endpoint__identity__internal')}"
glance::api::authtoken::auth_url:          "%{hiera('endpoint__identity__admin')}"
glance::api::authtoken::username:          'glance'
glance::api::authtoken::password:          "%{hiera('glance_api_password')}"
glance::api::authtoken::region_name:       "%{location}"
glance::api::authtoken::memcached_servers: '127.0.0.1:11211'

glance::config::api_config:
  cors/allowed_origin:
    value:   "https://%{hiera('public__address__dashboard')}"
  cors/allow_headers:
    value: >-
             CONTENT-MD5,X-IMAGE-META-CHECKSUM,X-STORAGE-TOKEN,ACCEPT-ENCODING,X-AUTH-TOKEN,
             X-IDENTITY-STATUS,X-ROLES,X-SERVICE-CATALOG,X-USER-ID,X-TENANT-ID,
             X-OPENSTACK-REQUEST-ID,ACCEPT,ACCEPT-LANGUAGE,CONTENT-TYPE,CACHE-CONTROL,
             CONTENT-LANGUAGE,EXPIRES,LAST-MODIFIED,PRAGMA,ORIGIN

# registry (node: image)
glance::registry::os_region_name:          "%{location}"
glance::registry::bind_host:               "%{::ipaddress_trp1}"
glance::registry::database_connection:     "mysql://glance:%{hiera('glance::db::mysql::password')}@%{hiera('service__address__db_regional')}/glance"
glance::registry::use_syslog:              true
glance::registry::log_facility:            'LOG_LOCAL3'
glance::registry::enable_v1_registry:      false

glance::registry::authtoken::username:     'glance'
glance::registry::authtoken::password:     "%{hiera('glance_api_password')}"
glance::registry::authtoken::auth_uri:     "%{hiera('endpoint__identity__internal')}"
glance::registry::authtoken::auth_url:     "%{hiera('endpoint__identity__admin')}"
glance::registry::authtoken::region_name:  "%{location}"

# keystone auth (node: identity)
glance::keystone::auth::auth_name:         'glance'
glance::keystone::auth::password:          "%{hiera('glance_api_password')}"
glance::keystone::auth::public_url:        "%{hiera('endpoint__image__public')}"
glance::keystone::auth::admin_url:         "%{hiera('endpoint__image__admin')}"
glance::keystone::auth::internal_url:      "%{hiera('endpoint__image__internal')}"
glance::keystone::auth::region:            "%{::location}"

# backend (node: image)
glance::backend::rbd::rbd_store_user: 'glance'
glance::backend::rbd::rbd_store_pool: 'images'

# policy (node: image)
glance::policy::policies:
  publicize_image:
    key:    'publicize_image'
    value:  'role:superuser or role:admin'

# rabbit mq (only for notifications)
glance::notify::rabbitmq::default_transport_url:  "%{hiera('service__transport__url')}"
glance::notify::rabbitmq::notification_driver:    'messagingv2'
#glance::notify::rabbitmq::rabbit_userid:         'glance'
#glance::notify::rabbitmq::rabbit_virtual_host:   'glance'
#glance::notify::rabbitmq::rabbit_hosts:
#  - "%{hiera('service__address__rabbitmq_01')}:5672"
#  - "%{hiera('service__address__rabbitmq_02')}:5672"
#  - "%{hiera('service__address__rabbitmq_03')}:5672"
