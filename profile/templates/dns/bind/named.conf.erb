#===================================================================#
# named.conf                                                        #
#                                                                   #
# This file is managed by Puppet. Any changes will be lost!         #
#===================================================================#

<% if @authoritative %>
# Include our RNDC keys
include "/etc/rndc-mdns.key";
include "/etc/rndc-admin.key";
<% end -%>

# Define an ACL that includes all UH-IaaS networks
acl iaas_nets {
    172.16.0.0/12;        # internal rfc1918
    192.168.0.0/24;       # vagrant public (rfc1918)
    158.39.77.0/24;       # bgo IPv4
    158.39.74.0/24;       # bgo IPv4
    158.37.63.0/24;       # osl IPv4
    158.39.75.0/24;       # osl IPv4
    2001:700:2:8300::/56; # bgo IPv6
    2001:700:2:8200::/56; # osl IPv6
};

<% if @authoritative %>
# Control which hosts can do updates via RNDC, using which keys
controls  {
    inet 127.0.0.1 port 953 allow { 127.0.0.1; } keys { "rndc-key-admin"; };
    inet <%= @my_mgmt_addr %> port 953 allow { <%= @admin_mgmt_addr %>; } keys { "rndc-key-admin"; };
    #inet <%= @my_transport_addr %> port 953 allow { <%= @mdns_transport_addr %>; } keys { "rndc-key-mdns"; };
};
<% end -%>

# General options for named
options  {
<% if @authoritative %>
    allow-query { any; };
    recursion no;
    allow-recursion { none; };
    allow-new-zones yes;
<% else %>
    allow-query { 127.0.0.1; ::1; iaas_nets; };
    recursion yes;
    allow-recursion { 127.0.0.1; ::1; iaas_nets; };
    allow-new-zones no;
<% end -%>
    directory "/var/named";
    dump-file "/var/named/data/named_dump.db";
    statistics-file "/var/named/data/named.stats";
    dnssec-enable yes;
    dnssec-validation no;
    empty-zones-enable yes;
    listen-on-v6 { any; };
<% if @forward_everything %>
    forward only;
    forwarders {
<% @forwarders.each do |fw| -%>
        <%= fw %>;
<% end -%>
    };
<% end -%>
};

<% if @authoritative %>
<% @forward_zones.each do |network, values| -%>
# Forward zone for <%= network %>, <%= values["zone"] %> (master)
zone "<%= values["zone"] %>" IN {
    type master;
    file "<%= values["filename"] %>";
    allow-update { <%= @admin_mgmt_addr %>; };
};
<% end -%>
<% @reverse_zones.each do |network, values| -%>
# Reverse (PTR) zone for <%= network %> network, <%= values["cidr"] %> (master)
zone "<%= values["origin"] %>" IN {
    type master;
    file "<%= values["filename"] %>";
    allow-update { <%= @admin_mgmt_addr %>; };
};
<% end -%>
<% else %>
<% unless @forward_zones.empty? %>
<% @forward_zones.each do |network, values| -%>
# Forward zone for <%= network %>, <%= values["zone"] %> (forward)
zone "<%= values["zone"] %>" IN {
    type forward;
    forwarders {
        <%= @ns_mgmt_addr %>;
    };
    forward only;
};
<% end -%>
<% end -%>
<% @reverse_zones.each do |network, values| -%>
# Reverse (PTR) zone for <%= network %> network, <%= values["cidr"] %> (forward)
zone "<%= values["origin"] %>" IN {
    type forward;
    forwarders {
        <%= @ns_mgmt_addr %>;
    };
    forward only;
};
<% end -%>
<% end -%>

<% if @host_is_ns_master %>
# Forward zone for frontend, uh-iaas.no (MASTER)
zone "uh-iaas.no" IN {
    type master;
    file "pz/uh-iaas.no";
    allow-update { none; };
    also-notify { <% @ns_slave_servers.each do |slave| -%><%= slave %>; <% end -%>};
};
<% elsif @host_is_ns_slave %>
# Forward zone for frontend, uh-iaas.no (SLAVE)
zone "uh-iaas.no" IN {
    type slave;
    file "sz/uh-iaas.no";
    masters { <%= @ns_master_server %>; };
};
<% end -%>

# Zones recommended by RFC 1912
include "/etc/named.rfc1912.zones";
